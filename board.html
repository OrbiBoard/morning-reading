<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>早读看板</title>
  <!-- 引入本地图标库 -->
  <link rel="stylesheet" href="../../OrbiBoard/src/renderer/remixicon-local.css" />
  <style>
    /* 核心变量定义，与主程序保持一致 */
    :root {
      --bg: #121621;
      --fg: #ededed;
      --muted: #94a3b8;
      --accent: #238f4a;
      --panel: rgba(255, 255, 255, 0.04);
      --item-bg: rgba(255, 255, 255, 0.04);
      --border: rgba(255, 255, 255, 0.12);
      --accent-rgb: 35, 143, 74;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Microsoft YaHei", sans-serif;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }

    .wrap {
      padding: 20px;
      height: 100vh;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 45vw;
      gap: 20px;
      flex: 1;
      min-height: 0;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
      transition: background 0.3s, border-color 0.3s;
    }

    .panel.right {
      overflow-y: auto;
    }

    /* 左侧时间区域 */
    .time-box {
      background: var(--item-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 30px;
      text-align: center;
      margin-bottom: 20px;
    }

    .time {
      font-size: clamp(60px, 10vw, 140px);
      line-height: 1;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      letter-spacing: -2px;
    }

    .date {
      font-size: clamp(18px, 2vw, 24px);
      margin-top: 10px;
      color: var(--muted);
    }

    .meta {
      margin-top: 12px;
      font-size: clamp(14px, 1.5vw, 18px);
      color: var(--accent);
      font-weight: 500;
      background: rgba(var(--accent-rgb), 0.1);
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
    }

    /* 按钮样式优化 */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      background: var(--item-bg);
      color: var(--fg);
      border: 1px solid var(--border);
    }

    .btn:hover {
      background: var(--border);
    }

    .btn.primary {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
    }
    
    .btn.primary:hover {
      filter: brightness(1.1);
    }

    /* 右侧卡片优化 */
    .quote-card {
      background: var(--item-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      transition: transform 0.2s;
    }
    
    .quote-card:hover {
      transform: translateY(-2px);
    }

    .quote-card.general {
      border-left: 4px solid var(--accent);
      background: linear-gradient(to right, rgba(var(--accent-rgb), 0.05), transparent);
    }

    .quote-card.specific.cn {
      border-left: 4px solid #f59e0b;
      background: linear-gradient(to right, rgba(245, 158, 11, 0.05), transparent);
    }

    .quote-card.specific.en {
      border-left: 4px solid #3b82f6;
      background: linear-gradient(to right, rgba(59, 130, 246, 0.05), transparent);
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .quote {
      font-size: clamp(20px, 2vw, 32px);
      line-height: 1.5;
      font-weight: 600;
    }

    .quote.from {
      margin-top: 8px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 400;
    }

    .poem-lines {
      margin-top: 10px;
      white-space: pre-line;
      font-size: 18px;
      line-height: 1.8;
      color: var(--fg);
      text-align: center;
    }

    .annotate-box {
      flex: 1;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: var(--item-bg);
      position: relative;
    }

    #annotate-frame {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }

    /* 滚动条美化 */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <!-- 左侧：时间与白板 -->
      <div class="panel left">
        <div class="time-box">
          <div class="time" id="t-time">--:--</div>
          <div class="date" id="t-date">----/--/--</div>
          <div class="meta" id="t-meta">加载中...</div>
        </div>
        
        <div class="annotate-box">
          <iframe id="annotate-frame" src="../annotate-fabric/whiteboard.html?showClose=0&showMinimize=0&showSave=1&variant=overlay&persistKey=morning-reading-board"></iframe>
        </div>

        <div style="margin-top: 16px; display: flex; justify-content: center;">
          <button class="btn" id="btn-exit" style="width: 100%; justify-content: center;">
            <i class="ri-logout-box-r-line"></i> 退出看板
          </button>
        </div>
      </div>

      <!-- 右侧：内容卡片 -->
      <div class="panel right">
        <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
          <button class="btn" id="btn-refresh"><i class="ri-refresh-line"></i> 刷新内容</button>
        </div>

        <div class="quote-card general">
          <div class="row">
            <i class="ri-star-line" style="font-size: 24px; color: var(--accent); margin-top: 4px;"></i>
            <div>
              <div class="quote" id="q-general"></div>
              <div class="quote from" id="q-general-from"></div>
            </div>
          </div>
        </div>

        <div class="quote-card specific cn" id="card-specific-cn" style="display:none;">
          <div class="row">
            <i class="ri-book-2-line" style="font-size: 24px; color: #f59e0b; margin-top: 4px;"></i>
            <div>
              <div class="quote" id="q-specific"></div>
              <div class="quote from" id="q-specific-from"></div>
              <div class="quote from" id="q-specific-translate"></div>
            </div>
          </div>
        </div>

        <div class="quote-card poem-full" id="card-poem-full" style="display:none;">
          <div class="poem-lines" id="q-poem-lines"></div>
        </div>

        <div class="quote-card specific en" id="card-specific-en" style="display:none;">
          <div class="row">
            <i class="ri-translate" style="font-size: 24px; color: #3b82f6; margin-top: 4px;"></i>
            <div>
              <div class="quote" id="q-specific-en"></div>
              <div class="quote from" id="q-specific-en-from"></div>
              <div class="quote from" id="q-specific-en-translate"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 注入主题逻辑
    const adjustBrightness = (hex, percent) => {
      const num = parseInt(hex.replace('#', ''), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) + amt;
      const G = (num >> 8 & 0x00FF) + amt;
      const B = (num & 0x0000FF) + amt;
      return '#' + (
        0x1000000 +
        (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
        (B < 255 ? B < 1 ? 0 : B : 255)
      ).toString(16).slice(1);
    };

    window.applyTheme = (mode, color) => {
      const root = document.documentElement;
      const isDark = mode === 'dark' || (mode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
      
      const accent = color || '#238f4a';
      root.style.setProperty('--accent', accent);
      
      const hex = accent.replace('#', '');
      const r = parseInt(hex.substring(0, 2), 16);
      const g = parseInt(hex.substring(2, 4), 16);
      const b = parseInt(hex.substring(4, 6), 16);
      root.style.setProperty('--accent-rgb', `${r}, ${g}, ${b}`);
      
      if (isDark) {
        root.style.setProperty('--bg', '#121621');
        root.style.setProperty('--fg', '#ededed');
        root.style.setProperty('--muted', '#94a3b8');
        root.style.setProperty('--panel', 'rgba(255, 255, 255, 0.04)');
        root.style.setProperty('--item-bg', 'rgba(255, 255, 255, 0.04)');
        root.style.setProperty('--border', 'rgba(255, 255, 255, 0.12)');
      } else {
        root.style.setProperty('--bg', '#f3f4f6');
        root.style.setProperty('--fg', '#1f2937');
        root.style.setProperty('--muted', '#6b7280');
        root.style.setProperty('--panel', '#ffffff');
        root.style.setProperty('--item-bg', '#f9fafb');
        root.style.setProperty('--border', '#e5e7eb');
      }
    };

    // 初始化主题
    (async () => {
      try {
        const cfg = await window.pluginAPI?.configGetAll('system');
        let mode = cfg?.themeMode || 'system';
        let color = cfg?.themeColor || '#238f4a';
        window.applyTheme(mode, color);
        
        // 监听配置变更
        if (window.pluginAPI?.onConfigChanged) {
          window.pluginAPI.onConfigChanged(({ scope, key, value }) => {
            if (scope === 'system') {
              if (key === 'themeMode') {
                mode = value;
                window.applyTheme(mode, color);
              }
              if (key === 'themeColor') {
                color = value;
                window.applyTheme(mode, color);
              }
            }
          });
        }

        // 监听系统深色模式变化
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
          if (mode === 'system') window.applyTheme('system', color);
        });
      } catch (e) { console.error('Theme init failed', e); }
    })();

    // 原有业务逻辑
    const $ = (s) => document.querySelector(s);
    window.pluginAPI?.ui.ensureStyles();
    $('#btn-exit').addEventListener('click',()=>window.pluginAPI?.windowControl('close'));

    async function tick(){
      const t = await window.pluginAPI?.getCurrentTime();
      const d = new Date(Number(t?.nowMs || Date.now()));
      let tz = 'Asia/Shanghai';
      try { const v = await window.pluginAPI?.configGet?.('system','timeZone'); if (v) tz = String(v); } catch (e) {}
      
      let parts = null;
      try { 
        parts = new Intl.DateTimeFormat('zh-CN', { 
          timeZone: tz, hour12: false, 
          year:'numeric', month:'2-digit', day:'2-digit', 
          hour:'2-digit', minute:'2-digit', second:'2-digit', weekday:'long' 
        }).formatToParts(d); 
      } catch (e) {}
      
      const get = (t) => parts ? (parts.find(p=>p.type===t)?.value || '') : null;
      const y = parts ? get('year') : String(d.getFullYear());
      const m = parts ? get('month') : String(d.getMonth()+1).padStart(2,'0');
      const day = parts ? get('day') : String(d.getDate()).padStart(2,'0');
      const hh = parts ? get('hour') : String(d.getHours()).padStart(2,'0');
      const mm = parts ? get('minute') : String(d.getMinutes()).padStart(2,'0');
      const ss = parts ? get('second') : String(d.getSeconds()).padStart(2,'0');
      const wk = parts ? get('weekday') : ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'][d.getDay()];
      
      $('#t-time').textContent = `${hh}:${mm}:${ss}`;
      $('#t-date').textContent = `${y}/${m}/${day} ${wk}`;
      
      const days = Number(t?.daysFromBase || 0);
      const weekIdx = Math.floor(days/7)+1;
      let even = Math.floor(days/7)%2===0;
      const off = await window.pluginAPI?.configGet('system','biweekOffset');
      if (off) even = !even;
      const tag = even? '双周':'单周';
      $('#t-meta').textContent = `第 ${weekIdx} 周 · ${tag} · 已开学 ${days} 天`;
    }
    
    let timer = null;
    function startClock(){ if (timer) clearInterval(timer); tick(); timer = setInterval(tick, 500); }
    
    async function getActiveMode(){
      const cfg = await window.pluginAPI?.configGetAll('morning-reading');
      const list = Array.isArray(cfg?.boardPeriods)?cfg.boardPeriods:[];
      const now = new Date();
      const w = now.getDay()===0?7:now.getDay();
      
      const base = await window.pluginAPI?.configGet('system','semesterStart') || await window.pluginAPI?.configGet('system','offsetBaseDate');
      const off = await window.pluginAPI?.configGet('system','biweekOffset');
      
      let even = null;
      if (base){ 
        try{ 
          const bd = new Date(String(base)+'T00:00:00'); 
          const diff = Math.floor((now-bd)/86400e3); 
          const wi = Math.floor(diff/7); 
          even = wi%2===0; 
          if (off) even=!even; 
        }catch (e) {} 
      }
      
      const match = (r)=>{ if(r==='any'||r==null) return true; if(even==null) return false; return r==='even'?even:!even; };
      
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      const cur = `${hh}:${mm}`;
      
      for(const p of list){ 
        if(p?.enabled===false) continue; 
        const onW = Array.isArray(p?.weekdays)?p.weekdays.includes(w):true; 
        const ok = match(p?.biweek); 
        const s = String(p?.start||'').slice(0,5); 
        const e = String(p?.end||'').slice(0,5); 
        
        if(!onW||!ok) continue; 
        if(/^\d{2}:\d{2}$/.test(s)&&/^\d{2}:\d{2}$/.test(e)){ 
          if(s<=cur && cur<e) return String(p?.type||'cn'); 
        } 
      }
      return 'cn';
    }
    
    async function fetchQuote(force){
      const mode = await getActiveMode();
      try{
        try{
          const rg = await fetch('https://api.v1.inkpick.cn/api/random',{cache:'no-store'});
          const jg = await rg.json();
          $('#q-general').textContent = String(jg?.content||'');
          const byG = [jg?.author||'', jg?.source||''].filter(Boolean).join(' · ');
          $('#q-general-from').textContent = byG ? byG : '';
        }catch (e) {}
        
        if(mode==='cn'){
          $('#card-specific-cn').style.display = '';
          $('#card-specific-en').style.display = 'none';
          $('#card-poem-full').style.display = '';
          
          let j = null;
          if(!force){ j = getCache('jinrishici'); }
          if(!j){ const r = await fetch('https://v2.jinrishici.com/one.json',{cache:'no-store'}); j = await r.json(); setCache('jinrishici', j); }
          
          const d = j?.data || {};
          $('#q-specific').textContent = String(d?.content||'');
          const org = d?.origin || {};
          const by = [org?.author||'', org?.title||''].filter(Boolean).join(' · ');
          $('#q-specific-from').textContent = by ? by : '';
          $('#q-specific-translate').textContent = '';
          try {
            const lines = Array.isArray(org?.content) ? org.content : [];
            $('#q-poem-lines').textContent = (lines.length ? lines.join('\n') : '');
          } catch (e) { $('#q-poem-lines').textContent = ''; }
          return;
        }
        
        if(mode==='en'){
          $('#card-specific-cn').style.display = 'none';
          $('#card-specific-en').style.display = '';
          $('#card-poem-full').style.display = 'none';
          
          const r = await fetch('https://apiv3.shanbay.com/weapps/dailyquote/quote',{cache:'no-store'});
          const j = await r.json();
          $('#q-specific-en').textContent = String(j?.content||'');
          const by = String(j?.author||'');
          $('#q-specific-en-from').textContent = by ? by : '';
          $('#q-specific-en-translate').textContent = String(j?.translation||'');
          $('#q-poem-lines').textContent = '';
          return;
        }
      }catch (e) {
        $('#q-general').textContent = '洛阳亲友如相问，一片冰心在玉壶';
        $('#q-general-from').textContent = '王昌龄 · 芙蓉楼送辛渐';
        $('#card-specific-cn').style.display = 'none';
        $('#card-specific-en').style.display = 'none';
        $('#card-poem-full').style.display = 'none';
        $('#q-poem-lines').textContent = '';
      }
    }
    
    function getCache(key){ try{ const raw = localStorage.getItem('mr.cache.'+key); if(!raw) return null; const obj = JSON.parse(raw); if(!obj||!obj.ts||!obj.data) return null; if(Date.now()-obj.ts > 20*60*1000) return null; return obj.data; }catch (e) { return null; } }
    function setCache(key,data){ try{ localStorage.setItem('mr.cache.'+key, JSON.stringify({ ts: Date.now(), data })); }catch (e) {} }
    
    $('#btn-refresh').addEventListener('click', ()=>fetchQuote(true));
    
    startClock();
    fetchQuote();
  </script>
</body>
</html>